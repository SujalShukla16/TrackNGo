<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACK N GO - Driver Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="bus-icon.png" type="image/png">
    <!-- Add these lines -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        #routeMap {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ... (keep existing header content) ... -->

        <main>
            <!-- ... (keep existing driver-info and driver-actions) ... -->

            <div class="map-container hidden" id="routeMapContainer">
                <h2 id="assignedRouteName">Assigned Route</h2>
                <div id="routeMap"></div> <!-- Changed from map-placeholder to actual map div -->
                <button class="back-btn" id="backFromRouteMap">Back to Dashboard</button>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 TRACK N GO. All rights reserved.</p>
        </footer>
    </div>

    <!-- Add these scripts -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const driverId = sessionStorage.getItem('driverId');
            const driverRoute = sessionStorage.getItem('driverRoute');
            const driverBus = sessionStorage.getItem('driverBus');
            
            if (!driverId) {
                alert('Please login first');
                window.location.href = 'index.html';
                return;
            }

            // ... (keep existing driver info display code) ...

            let map;
            let routingControl;

            function initMap() {
                map = L.map('routeMap').setView([18.8943, 73.1768], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            }

            function setRoute1() {
                if (!map) {
                    console.error("Map not initialized!");
                    return;
                }

                if (routingControl) {
                    map.removeControl(routingControl);
                }

                const route1 = {
                    waypoints: [
                        L.latLng(18.8943, 73.1768), 
                        L.latLng(18.9000, 73.1900), 
                        L.latLng(18.9030, 73.2000), 
                        L.latLng(18.9061, 73.2089)  
                    ]
                };

                // Clear existing markers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                const stopIcon = L.divIcon({
                    className: 'stop-icon',
                    html: '<div style="width: 12px; height: 12px; background: white; border: 2px solid black; border-radius: 50%;"></div>',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                const stops = [
                    { lat: 18.9000, lon: 73.1900, name: "Stop 1" },
                    { lat: 18.9030, lon: 73.2000, name: "Stop 2" }
                ];

                stops.forEach(stop => {
                    L.marker([stop.lat, stop.lon], { icon: stopIcon })
                        .addTo(map)
                        .bindTooltip(stop.name, { permanent: true, direction: "top" });
                });

                routingControl = L.Routing.control({
                    waypoints: route1.waypoints,
                    routeWhileDragging: false,
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1'
                    }),
                    lineOptions: {
                        styles: [{ color: 'blue', opacity: 0.7, weight: 5 }]
                    },
                    createMarker: function(i, waypoint, n) {
                        if (i === 0 || i === n - 1) {
                            return L.marker(waypoint.latLng, {
                                icon: L.divIcon({
                                    className: 'text-cloud',
                                    html: `<div class="text-cloud">${i === 0 ? 'PHOCC' : 'Dand Fata'}</div>`
                                })
                            });
                        }
                        return null;
                    }
                }).addTo(map);

                routingControl.on('routesfound', function(e) {
                    const itineraryPanel = document.querySelector('.leaflet-routing-container');
                    if (itineraryPanel) {
                        itineraryPanel.style.display = 'none';
                    }
                    
                    map.fitBounds(e.routes[0].bounds);
                });

                routingControl.on('routingerror', function(err) {
                    console.error('Routing error:', err);
                    alert('Failed to load route. Please try again later.');
                });
            }

            // ... (keep existing event listeners) ...

            viewRouteBtn.addEventListener('click', function() {
                document.querySelector('.driver-info').classList.add('hidden');
                document.querySelector('.driver-actions').classList.add('hidden');
                routeMapContainer.classList.remove('hidden');
                
                assignedRouteName.textContent = driverRoute;
                
                // Initialize map and show route based on assigned route
                if (!map) {
                    initMap();
                }
                
                if (driverRoute === "Route 1: Mohopada to Panvel") {
                    setRoute1();
                }
                // Add conditions for other routes as needed
                
                // Force map to resize and redraw
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            });
            
            // ... (rest of your existing code) ...
        });
    </script>
</body>
</html>
